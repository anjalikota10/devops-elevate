pipeline {
    agent any
    
    environment {
        // AWS Configuration
        AWS_REGION = 'us-east-1'
        ECR_REPOSITORY = 'php-eks'
        
        // Image Configuration
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // Build Configuration
        DOCKERFILE_PATH = 'app1/Dockerfile'
        BUILD_CONTEXT = 'app1'
        
        // EC2 Configuration
        EC2_HOST = '44.201.239.138'
        EC2_USER = 'ubuntu'
        APP_PATH = '/var/www/html/terraform-new/app1'
        
        // Git Configuration
        GIT_BRANCH = 'origin/terraform'
    }
    
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.COMMIT_DATE = sh(returnStdout: true, script: "git show -s --format=%ci ${GIT_COMMIT}").trim()
                    env.COMMIT_SHORT = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()
                }
                echo "Commit Date: ${env.COMMIT_DATE}"
                echo "Commit Hash: ${env.COMMIT_SHORT}"
                sh script: 'git rev-parse --abbrev-ref HEAD'
            }
        }
        
        stage('Build & Push to ECR') {
            steps {
                script {
                    echo "Starting build and push process..."
                    
                    // Use AWS credentials binding to get account ID dynamically
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        // Get AWS Account ID dynamically
                        def AWS_ACCOUNT_ID = sh(
                            returnStdout: true, 
                            script: 'aws sts get-caller-identity --query Account --output text'
                        ).trim()
                        
                        def ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
                        def IMAGE_NAME = "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
                        def LATEST_IMAGE = "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"
                        
                        echo "AWS Account ID: ${AWS_ACCOUNT_ID}"
                        echo "ECR Registry: ${ECR_REGISTRY}"
                        
                        // Authenticate with ECR
                        echo "Authenticating with AWS ECR..."
                        sh """
                            aws ecr get-login-password --region ${AWS_REGION} | \
                            docker login --username AWS --password-stdin ${ECR_REGISTRY}
                        """
                        
                        // Build Docker image
                        echo "Building Docker image..."
                        
                        // List files for debugging
                        echo "Current directory contents:"
                        sh 'ls -la'
                        sh 'pwd'
                        
                        // Check if Dockerfile exists
                        if (fileExists(DOCKERFILE_PATH)) {
                            echo "Dockerfile found at: ${DOCKERFILE_PATH}"
                        } else {
                            error "Dockerfile not found at: ${DOCKERFILE_PATH}"
                        }
                        
                        sh """
                            docker build \
                                -f ${DOCKERFILE_PATH} \
                                --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                                --build-arg VCS_REF=${env.COMMIT_SHORT} \
                                --build-arg BUILD_NUMBER=${BUILD_NUMBER} \
                                -t ${IMAGE_NAME} \
                                -t ${LATEST_IMAGE} \
                                ${BUILD_CONTEXT}
                        """
                        
                        echo "Docker image built successfully"
                        
                        // Push both tagged and latest images
                        echo "Pushing images to ECR..."
                        sh """
                            echo "Pushing image with tag: ${IMAGE_TAG}"
                            docker push ${IMAGE_NAME}
                            
                            echo "Pushing image with tag: latest"
                            docker push ${LATEST_IMAGE}
                        """
                        
                        echo "Images pushed to ECR successfully"
                        echo "Image: ${IMAGE_NAME}"
                        
                        // Store for later stages
                        env.ECR_REGISTRY = ECR_REGISTRY
                        env.IMAGE_NAME = IMAGE_NAME
                        env.LATEST_IMAGE = LATEST_IMAGE
                    }
                }
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                script {
                    echo "Deploying to EC2 instance: ${EC2_HOST}..."
                    
                    // Create deployment script
                    def deployScript = """
                        set -e
                        
                        echo "Authenticating with AWS ECR..."
                        aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin ${env.ECR_REGISTRY}
                        
                        echo "Navigating to application directory..."
                        cd ${APP_PATH}
                        
                        echo "Stopping existing containers..."
                        docker-compose down || true
                        
                        echo "Cleaning up old images..."
                        docker image prune -f
                        
                        echo "Pulling latest image from ECR..."
                        docker pull ${env.LATEST_IMAGE}
                        
                        echo "Tagging image for docker-compose..."
                        docker tag ${env.LATEST_IMAGE} php-app:latest
                        
                        echo "Starting containers with docker-compose..."
                        docker-compose up -d
                        
                        echo "Waiting for services to be healthy..."
                        sleep 10
                        
                        echo "Checking container status..."
                        docker-compose ps
                        
                    #    echo "Running health check..."
                     #   for i in {1..30}; do
                      #      if curl -f http://44.201.239.138:8081/ >/dev/null 2>&1; then
                       #         echo "Application is healthy!"
                        #        exit 0
                         #   fi
                          #  echo "Waiting for application to be ready... (\$i/30)"
                           # sleep 2
                       # done
                        
                       # echo "Health check failed!"
                       # docker-compose logs
                       # exit 1
                    """
                    
                    // Execute deployment via SSH
                    sshagent(credentials: ['ec2-ssh']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no \
                                -o UserKnownHostsFile=/dev/null \
                                ${EC2_USER}@${EC2_HOST} \
                                'bash -s' << 'ENDSSH'
${deployScript}
ENDSSH
                        """
                    }
                    
                    echo "Deployment completed successfully!"
                }
            }
        }
    }
    
    post {
        success {
            echo """
            ====================================
            DEPLOYMENT SUCCESSFUL!
            ====================================
            Image: ${env.IMAGE_NAME}
            Application URL: http://${EC2_HOST}:8080
            Build: #${BUILD_NUMBER}
            Commit: ${env.COMMIT_SHORT}
            ====================================
            """
        }
        
        failure {
            echo """
            ====================================
            DEPLOYMENT FAILED!
            ====================================
            Build: #${BUILD_NUMBER}
            Commit: ${env.COMMIT_SHORT}
            ====================================
            """
        }
        
        always {
            script {
                if (env.IMAGE_NAME) {
                    echo "Cleaning up local Docker images..."
                    sh """
                        docker rmi ${env.IMAGE_NAME} || true
                        docker rmi ${env.LATEST_IMAGE} || true
                        docker image prune -f || true
                    """
                }
            }
        }
    }
}
